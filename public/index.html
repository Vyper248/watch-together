<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>Watching Together</title>
        <style>
            
            * {
                box-sizing: border-box;
            }
            
            h1 {
                position: absolute;
                top: 50px;
                font-size: 4em;
            }
        
            html, body {
                height: 100%;
                color: white;
                margin: 0px;
                font-family: sans-serif;
            }
            
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                background-color: black;
            }
            
            input[type="text"]{
                color: black;
                padding: 10px;
                border-radius: 5px;
                border: 1px solid black;
            }
            
            input[type="text"]:focus {
                border: 1px solid deepskyblue;
            }
            
            input[type="file"] {
                color: white;
                width: 0.1px;
                height: 0.1px;
                opacity: 0;
                overflow: hidden;
                position: absolute;
                z-index: -1;
            }
            
            video {
                width: 100%;
            }
            
            video::-webkit-media-controls-fullscreen-button {
                display: none;
            }

            #videoContainer {
                width: 100%;
                position: relative;
                display: none;
                justify-content: center;
                align-items: center;
            }
            
            .videoText {
                position: fixed;
                bottom: 50px;
                z-index: 2;
                font-size: 3em;
                transition: 0.3s;
                opacity: 0;
                color: lightgray;
                text-shadow: 0px 0px 5px black;
            }
            
            #videoText1 {
                left: 50px;
            }
            
            #videoText2 {
                right: 50px;
            }
            
            .button {
                padding: 10px;
                width: 150px;
                background-color: white;
                border: 1px solid black;
                border-radius: 5px;
                margin: 10px;
                transition: 0.3s;
                color: black;
                text-align: center;
                cursor: pointer;
            }
            
            .button.wide {
                width: 200px;
                font-size: 0.9em;
            }
            
            .button:hover {
                background-color: lightgray;
            }
            
            .button:focus {
                outline: none;
            }
            
            .button:active {
                background-color: darkgray;
            }
            
            #phase1, #phase2 {
                display: flex;
                flex-direction: column;
                align-items: center;
                border: 1px solid white;
                border-radius: 10px;
                padding: 50px;
            }
            
            #phase2 {
                display: none;
            }
            
            #error {
                color: red;
                font-weight: bold;
            }
            
            #fullscreenBtn {
                position: fixed;
                bottom: 50px;
                right: 50px;
                color: gray;
                background-color: dimgray;
                font-size: 2em;
                cursor: pointer;
            }
            
            #fullscreenBtn div {
                position: absolute;
                top: 0px;
                left: 0px;
                -webkit-user-select: none;  /* Chrome all / Safari all */
                -moz-user-select: none;     /* Firefox all */
                -ms-user-select: none;      /* IE 10+ */
                user-select: none;          /* Likely future */   
            }
            
            #fullscreenBtn #f1 {
                transform: rotate(45deg) translate(-10px);
            }
            
            #fullscreenBtn #f2 {
                transform: rotate(-45deg) translate(-10px);
            }
            
            #fullscreenBtn #f3 {
                transform: rotate(135deg) translate(-10px);
            }
            
            #fullscreenBtn #f4 {
                transform: rotate(-135deg) translate(-10px);
            }
        
        </style>
    </head>
    <body>
<!-- Start a new instance or join existing one -->
        <div id="phase1">
            <h1>Watching Together</h1>
            
            <h3>Start a New Session</h3>
            <button class="button" id="startNewBtn">Start New</button>
        
            <h3>Or Join Existing</h3>
            <input type="text" id="id">
            <button class="button" id="joinExistingBtn">Join</button>
            
            <div id="error"></div>
        </div>
        
        <div id="phase2">
            <h1>Watching Together</h1>
            <label id="sessionID">Your ID is: </label>
            <h3>Select Video to Watch</h3>
            <input type="file" id="fileSelect">
            <label class="button wide" for="fileSelect" id="fileLabel">Choose a file</label>
            <button class="button" id="startBtn">Start!</button>
        </div>
        
        <div id="videoContainer">
            <video controls autoplay name="media" controlsList="nofullscreen nodownload">
                <source src="" type="video/webm">
            </video>
            <div id="videoText1" class="videoText">Test</div>
            <div id="videoText2" class="videoText">Test</div>
            <div id="fullscreenBtn">
                <div id="f1">&#8592;</div>
                <div id="f2">&#8592;</div>
                <div id="f3">&#8592;</div>
                <div id="f4">&#8592;</div>
            </div>
        </div>
        
        
        <script src="/socket.io/socket.io.js"></script>
        <script>
        
            const video = document.querySelector('video');
            const source = document.querySelector('source');
            const videoContainer = document.querySelector('#videoContainer');
            const fileInput = document.querySelector('#fileSelect');
            const idInput = document.querySelector('#id');
            const startNewBtn = document.querySelector('#startNewBtn');
            const joinExistingBtn = document.querySelector('#joinExistingBtn');
            const startBtn = document.querySelector('#startBtn');
            const fileLabel = document.querySelector('#fileLabel');
            const sessionID = document.querySelector('#sessionID');
            const phase1 = document.querySelector('#phase1');
            const phase2 = document.querySelector('#phase2');
            const error = document.querySelector('#error');
            const fullscreenBtn = document.querySelector('#fullscreenBtn');
            const videoText1 = document.querySelector('#videoText1');
            const videoText2 = document.querySelector('#videoText2');
            
            const socket = io();
            let blocked = false;
            let seekTimer = null;
            let clientID;
            
            let timers = {
                keyTimer1: null,
                keyTimer2: null,
            }

            fileInput.addEventListener('change', () => {
                let file = fileInput.files[0];
                fileLabel.innerText = file.name;
                let objectURL = window.URL.createObjectURL(file);
                video.src = objectURL;
                video.pause();
            });
            
            startBtn.addEventListener('click', () => {
                videoContainer.style.display = 'flex';
                phase2.style.display = 'none';
            });
            
            startNewBtn.addEventListener('click', () => {
                socket.emit('newRoom');
                phase1.style.display = 'none';
                phase2.style.display = 'flex';
            });
            
            joinExistingBtn.addEventListener('click', () => {
                let id = idInput.value;
                socket.emit('join', id);
            });
            
            fullscreenBtn.addEventListener('click', () => {
                openFullscreen(videoContainer);
                fullscreenBtn.style.display = 'none';
            });
            
            video.addEventListener('pause', ()=>{
                if (blocked) return;
                socket.emit('video-message', {type: 'pause', id: clientID});
            });
            
            video.addEventListener('play', ()=>{
                if (blocked) return;
                socket.emit('video-message', {type: 'play', id: clientID});
            });
            
            video.addEventListener('seeking', () => {
                if (blocked) return;
                if (seekTimer) {
                    clearTimeout(seekTimer)
                    seekTimer = null;
                }
                seekTimer = setTimeout(()=>{
                    socket.emit('video-message', {type: 'seek', time: video.currentTime, id: clientID});
                }, 100);
                
            });
            
            document.querySelector('body').addEventListener('keydown', (e) => {
                receiveKey(videoText2, e, 'keyTimer1');
                socket.emit('keypress', {code: e.code, key: e.key, id: clientID});
            });

            socket.on('connect', function(){
                console.log('connected');
            });
            
            socket.on('newRoom', data => {
                clientID = data;
                sessionID.innerText = 'Your ID is: '+data;
            });
            
            socket.on('joined', data => {
                sessionID.innerText = 'Your ID is: '+data;
                clientID = data;
                phase1.style.display = 'none';
                phase2.style.display = 'flex';
            });
            
            socket.on('keypress', data => {
                receiveKey(videoText1, data, 'keyTimer2');
            });
            
            socket.on('video-message', data => {
                if (data.type === 'pause'){
                    blocked = true;
                    video.pause();
                    setTimeout(()=>{blocked = false}, 100);
                } else if (data.type === 'play'){
                    blocked = true;
                    video.play();
                    setTimeout(()=>{blocked = false}, 100);
                } else if (data.type === 'seek'){
                    blocked = true;
                    video.currentTime = data.time;
                    setTimeout(()=>{blocked = false}, 100);
                }
            });
            
            socket.on('error-message', data => {
                error.innerText = data.message;
            });
            
            socket.on('disconnect', function(){
                console.log('disconnected');
            });
            
            document.addEventListener('webkitfullscreenchange', () => {
                if (!document.webkitIsFullScreen) {
                    fullscreenBtn.style.display = 'block';
                }
            });
            
            function receiveKey(element, data, timer){
                element.style.opacity = 1;
                
                if (timers[timer]) {
                    clearTimeout(timers[timer]);
                    timers[timer] = null;
                } else {
                    element.innerHTML = '';
                }
                
                if (data.code === 'Space') element.innerHTML += ' ';
                else if (data.code === 'Backspace') element.innerHTML = element.innerHTML.slice(0,-1);
                else if (data.key.length === 1) element.innerHTML += data.key;
                
                if (video.paused) element.style.bottom = '100px';
                else element.style.bottom = '50px';
                
                timers[timer] = setTimeout(()=>{
                    element.style.opacity = 0;
                    timers[timer] = null;
                }, 2000);
            }
            
            function openFullscreen(elem) {
              if (elem.requestFullscreen) {
                elem.requestFullscreen();
              } else if (elem.mozRequestFullScreen) { /* Firefox */
                elem.mozRequestFullScreen();
              } else if (elem.webkitRequestFullscreen) { /* Chrome, Safari and Opera */
                elem.webkitRequestFullscreen();
              } else if (elem.msRequestFullscreen) { /* IE/Edge */
                elem.msRequestFullscreen();
              }
            }

        </script>
    </body>
</html>